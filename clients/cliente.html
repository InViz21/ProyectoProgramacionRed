<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Cliente Web – Proyecto Distribuido</title>
<style>
body { font-family: Arial; max-width: 900px; margin: 20px auto; }
input, button { padding: 6px; margin: 5px; }
section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
h2 { margin-top: 0; }
pre { background: #f4f4f4; padding: 10px; }
</style>
</head>
<body>

<h1>Cliente Web – Sistema Distribuido</h1>
<p>Este cliente se conecta a:</p>
<ul>
  <li><b>S1 (HTTPS):</b> https://localhost:4430</li>
  <li><b>S3 (DB REST):</b> http://localhost:5002</li>
</ul>

<hr>

<!-- ======================================================= -->
<!-- =============== 1. CREAR USUARIO ======================= -->
<!-- ======================================================= -->
<section>
<h2>1. Crear Usuario (S3)</h2>
<input id="cu_user" placeholder="Usuario"><br>
<input id="cu_pass" placeholder="Contraseña"><br>
<button onclick="crearUsuario()">Crear Usuario</button>
<pre id="cu_out"></pre>
</section>

<!-- ======================================================= -->
<!-- ================== 2. LOGIN (pedir OTP) ================ -->
<!-- ======================================================= -->
<section>
<h2>2. Login (solicitar OTP por Telegram)</h2>
<input id="lg_user" placeholder="Usuario"><br>
<input id="lg_pass" placeholder="Contraseña"><br>
<button onclick="login()">Login → Enviar OTP</button>
<pre id="lg_out"></pre>
</section>

<!-- ======================================================= -->
<!-- =============== 3. VALIDAR OTP ========================= -->
<!-- ======================================================= -->
<section>
<h2>3. Validar OTP (obtener token JWT)</h2>
<input id="vo_user" placeholder="Usuario"><br>
<input id="vo_code" placeholder="Código OTP"><br>
<button onclick="validarOTP()">Validar OTP</button>
<pre id="vo_out"></pre>
</section>

<!-- ======================================================= -->
<!-- =============== 4. PROBAR TOKEN ======================== -->
<!-- ======================================================= -->
<section>
<h2>4. Probar Token → /profile</h2>
<button onclick="verPerfil()">Ver Perfil</button>
<pre id="pf_out"></pre>
</section>

<!-- ======================================================= -->
<!-- ================= 5. CRUD ITEMS ======================== -->
<!-- ======================================================= -->
<section>
<h2>5. Items CRUD (a través de S1)</h2>

<h3>Crear Item</h3>
<input id="it_name" placeholder="Nombre del item">
<button onclick="crearItem()">Crear</button>

<h3>Listar Items</h3>
<button onclick="listarItems()">Listar</button>

<pre id="it_out"></pre>
</section>

<script>
/* CONFIGURACIÓN */
const S1 = "https://localhost:4430";   // API Gateway con HTTPS
const S3 = "http://localhost:5002";    // DB REST

/* ----------------------------
   1. CREAR USUARIO (S3)
-----------------------------*/
async function crearUsuario() {
  const username = document.getElementById("cu_user").value;
  const password = document.getElementById("cu_pass").value;

  const r = await fetch(`${S3}/users`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  const j = await r.json();
  document.getElementById("cu_out").textContent = JSON.stringify(j, null, 2);
}

/* ----------------------------
   2. LOGIN (enviar OTP)
-----------------------------*/
async function login() {
  const username = document.getElementById("lg_user").value;
  const password = document.getElementById("lg_pass").value;

  const r = await fetch(`${S1}/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  const j = await r.json();
  document.getElementById("lg_out").textContent = JSON.stringify(j, null, 2);
}

/* ----------------------------
   3. VALIDAR OTP (obtener JWT)
-----------------------------*/
async function validarOTP() {
  const username = document.getElementById("vo_user").value;
  const code = document.getElementById("vo_code").value;

  const r = await fetch(`${S1}/validate-otp`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, code })
  });

  const j = await r.json();
  document.getElementById("vo_out").textContent = JSON.stringify(j, null, 2);

  if (j.token) {
    localStorage.setItem("token", j.token);
    alert("Token guardado ✔");
  }
}

/* ----------------------------
   4. Ver perfil protegido
-----------------------------*/
async function verPerfil() {
  const token = localStorage.getItem("token");

  const r = await fetch(`${S1}/profile`, {
    headers: { "Authorization": "Bearer " + token }
  });

  const j = await r.json();
  document.getElementById("pf_out").textContent = JSON.stringify(j, null, 2);
}

/* ----------------------------
   5. CRUD ITEMS (a través de S1)
-----------------------------*/
async function crearItem() {
  const token = localStorage.getItem("token");
  const name = document.getElementById("it_name").value;

  const r = await fetch(`${S1}/items`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ name })
  });

  const j = await r.json();
  document.getElementById("it_out").textContent = JSON.stringify(j, null, 2);
}

async function listarItems() {
  const token = localStorage.getItem("token");

  const r = await fetch(`${S1}/items`, {
    headers: { "Authorization": "Bearer " + token }
  });

  const j = await r.json();
  document.getElementById("it_out").textContent = JSON.stringify(j, null, 2);
}
</script>

</body>
</html>

